# Fulfillment Application Design Document

1. Fulfillment of sales orders (including basic picking and packing) and receiving of purchase orders
2. Inventory management including issuance and receipt, and inventory reservation for sales orders

## [Store Fulfillment Lifecycle](https://docs.hotwax.co/documents/v/learn-hotwax-oms/business-process-models/store.fulfillment)


Order fulfillment is 3 step process,

### Step 1: 
The staff gets the list of Outstanding orders 
*   Search in "ORDER" solr document, look for 
  * facilityId, item approved, shipmentMethod, fulfillmentStatus is NULL


  * The user then starts the fulfillment process for set of orders by creating a [Fulfillment wave of orders](createOrderFulfillmentWave.md). A [PickList](../oms/createPickList) is returned for the user to go pick items for preparing the shipments.
     *  Background process: [Shipments](../oms/createShipment.md) are created for orders.
        - If the order item is a kit product, a distinct reservation will be created with the same order item for each product in the kit. When creating a picklist and shipment, all reservations will be included to ensure a proper fulfillment lifecycle.

Alternativley the user can choose to not proceed with picking and instead choose the following actions:

  *  The user can choose to [rejectOrderItems](rejectOrderItems.md) if for some reason orderItem cannot be fulfilled.
  *  The user can choose to [cancelOrderItem](cancelOrderItem.md) on request of the customer or Customer Service Rep (CSR).

### Step 2: 
User completes the [Packing](packShipment.md). Alternatively user can choose to edit autogenerated Shipment.
  *  [rejectShipmentItem](rejectShipmentItem.md).
  *  Add [ShipmentPackage](../oms/createShipmentPackage.md)
  *  Move ShipmentItems between packages.
  *  Activate gift card.
  *  After edits [packShipment](packShipment.md).
  *  [getShippingLabel](getShippingLabel.md).

### Step 3:
User marks Shipment shipped.
  * reprint shipping label and other documents
  * [voidShipmentLabel](voidShipmentLabel.md) and request it again.


## [Shipment lifecycle](../oms/ShipmentStatusWorkflow.md)
Shipment is created in SHIPMENT_INPUT, then SHIPMENT_APPROVED to SHIPMENT_PACKED and then SHIPMENT_SHIPPED

### [On SHIPMENT_APPROVED:](approveShipment.md)
* If the facility is part of the `AUTO_SHIPPING_LABEL` facility group. The service calls [getShippingLabel](getShippingLabel.md) from the logistics company.
  * On successful execution of shipping label RateShopping, update ShipmentRouteSegment. Set `shipmentMethodTypeId`, `carrierPartyId`, `actualCost`, `carrierServiceStatusId` (SHRSCS_CONFIRMED). 

* Once we have Shipping label, Shipment can be moved to SHIPMENT_PACKED status.
  * If `isTrackingRequired` is set to **N** in the ProductStoreShipmentMeth entity for the given Shipment Method, then the user can pack the shipment without a shipping label or tracking code.

### On SHIPMENT_PACKED:
* Ship (Handover in case of BOPIS) the Shipment moves Shipment status to Shipped
* [Get shipping label](getShippingLabel.md) if auto shipping label is disabled at the facility and label is not already fetched.

### On SHIPMENT_SHIPPED:
* [createOrderShipmentInventoryIssuance](createOrderShipmentInventoryIssuance.md)
* Order Item is marked Completed
* Update Shopify order Fulfilled

**Modify contents of the Shipment after it is already SHIPMENT_APPROVED or SHIPMENT_PACKED.**
Why does the shipment have to be moved out of "approved" status to edit it's contents? For example fulfillment team may want to reject an item after begining pack pick process, in which case shipment will already be packed.

-   To pack a Shipment, we need shipping label. To give shipping label, shipping carrier need to know the package dimensions and weight.
-   Approving the shipment means communicates that the shipment is now ready for packing, and package type and weight are now final.


1. If the Approved shipment should be edited, The Shipment is first [reinitializeShipment](reinitializeShipment.md).To avoid error, the reinitialize process calls [voidShipmentLabel](voidShipmentLabel.md).
2. In case the Packed shipment should be edited, first [reinitializeShipment](reinitializeShipment.md). It moves shipment from SHIPMENT_PACKED status to SHIPMENT_INPUT, ensure to [voidShipmentPackageLabel](voidShipmentPackageLabel.md). Recompute the [ShipmentPackageWeight](calcShipmentPackageTotalWeight.md).

```
    <!-- ShipmentRouteSegment CarrierService status -->
    <StatusType description="ShipmentRouteSegment:CarrierService" hasTable="N"  statusTypeId="SHPRTSG_CS_STATUS"/>
    <StatusItem description="Not Started" sequenceId="01" statusCode="NOT_STARTED" statusId="SHRSCS_NOT_STARTED" statusTypeId="SHPRTSG_CS_STATUS"/>
    <StatusItem description="Confirmed" sequenceId="02" statusCode="CONFIRMED" statusId="SHRSCS_CONFIRMED" statusTypeId="SHPRTSG_CS_STATUS"/>
    <StatusItem description="Accepted" sequenceId="03" statusCode="ACCEPTED" statusId="SHRSCS_ACCEPTED" statusTypeId="SHPRTSG_CS_STATUS"/>
    <StatusItem description="Voided" sequenceId="08" statusCode="VOIDED" statusId="SHRSCS_VOIDED" statusTypeId="SHPRTSG_CS_STATUS"/>
    <StatusValidChange statusId="SHRSCS_NOT_STARTED" statusIdTo="SHRSCS_CONFIRMED" transitionName="Confirm"/>
    <StatusValidChange statusId="SHRSCS_CONFIRMED" statusIdTo="SHRSCS_ACCEPTED" transitionName="Accept"/>
    <StatusValidChange statusId="SHRSCS_CONFIRMED" statusIdTo="SHRSCS_VOIDED" transitionName="Void"/>
    <StatusValidChange statusId="SHRSCS_ACCEPTED" statusIdTo="SHRSCS_VOIDED" transitionName="Void"/>
```

## HotWax Commerce Shipment 


### [Setting up a New Shipping Carrier](https://github.com/saastechacademy/foundation/blob/main/ofbiz-framework/intermediate/setupShippingCarrier.md)

### Pre-Requisits, NOT included in Fulfillment App. 
1) Setup Facility with Locations
2) Setup Product and Inventory configurations
3) Import product inventory
4) Import Orders 
5) Setup Fulfillment user roles and responsibilities.
6) Each Facility has list of Shipping Carriers and may be billing accounts with carrier. 

### Fulfillment App
1) PickList and Picking
2) Shipment lifecycle
   * Outgoing Shipment
   * Incoming Shipment
3) Shipping Gateway configuration
4) Inventory physical cycle count


***Shipping Gateway configuration***
1) [Shipping Carrier](/ofbiz-framework/intermediate/setupShippingCarrier.md)


## UAT

### List of scenarios to test createOrderFulfillmentWave
*   PickList is created, the list of assigned Pickers reconciles with the request
*   The number of unique shipGroupSeqId reconciles with the number of Shipments created.
*   The number records for each orderId and ShipmentId combination in OrderShipment table reconciles with ShipmentItems

### Ships together scenario
### Digital Goods shipment
### Physical Gift card shipment
### Marketing material and bonus material

### Scenarios 
*   Update shipTo Postal address after shipment is created. The shipping address should be first updated on OrderItemShipGroup and then update the address on Shipment.
  * Update contactMechId on OrderItemShipGroup
  * Update destinationContactMechId on Shipment
  * Update destContactMechId on ShipmentRouteSegment
*   Update shipTo Telecom number after shipment is created. The shipping Telecom should be first updated on OrderItemShipGroup and then update the Telecom on Shipment.
  * Update telecomContactMechId on OrderItemShipGroup
  * Update destinationTelecomNumberId on Shipment
  * Update destTelecomNumberId on ShipmentRouteSegment

## Questions 
1.  Why do we reset carrierPartyId and shipmentMethodTypeId on reinitializeShipment method? Both these fields are HC custom.
2.  What if OrderItemShipGrp has shipment carrier partyId and shipment method set, Do we rate shop or not? What business scenarios are related to this? 
3.  What if during Shipment processing, we may have to get ShippingLabel. In this case we can skip the rate shopping step, Read carrrier Party and shipmentMethodTypeId from the ShipmentRouteSegment entity.
4.  Are we honoring the shipmentMethodType suggested by brokering engine? Brokering engine evaluates distance between fulfillment location and deliver location, if the distance is within the range of ZONE 2, Brokering engine suggests ShipmentMethodType. The Rate shopping process should include the suggested shipmentMethodType.

## [Inventory Management](inventoryManagementProcess.md)

## Transfer Order

The advice for moving inventory from one storage facility to other. It helps manage the workflow. 
The TO is an OrderType like SalesOrder and PurchaseOrder. 
The API for to [createTransferOrder](createTransferOrder.md) builds on the [createOrder](../oms/createOrder.md)
An inventory storage location may receive [InTransferShipment](createInTransferShipment.md) or ship [OutTransferShipment](createOutTransferShipment.md) for a transfer order. 

### Scenarios
The Transfer Orders will facilitate movement of inventory between locations, the scenarios being:
1. TOs where Fulfillment location is managed by OMS and Receiving location is managed by third party e.g. Store to Warehouse
2. TOs where Fulfillment location is managed by third party and Receiving location is managed by OMS e.g. Warehouse to Store
3. TOs where both Fulfillment and Receiving locations are managed by OMS e.g. Store to Store

### Design
1. The Create Transfer Orders request to OMS will include an indicator like a **statusFlowId** on the basis of which OMS can decide whether the Transfer Order
should be only fulfilled in OMS or only received in OMS or should be both fulfilled and received in OMS.
2. This statusFlowId indicator will help in correctly transitioning the Transfer Order Item status and hence facilitate the transfer order 
fulfillment and receiving as required in the system.
3. The statusFlowId will be managed at OrderHeader level and new Order Item status and Status Flow Transitions will be added to manage the life cycle 
of Transfer Order.

#### Valid Status for Transfer Orders

Three new Order Item Status will be introduced to manage the lifecycle of Transfer Orders - ITEM_PENDING_FULFILL, ITEM_PENDING_RECEIPT and ITEM_PENDING_FULFILL_RECEIPT.

1. Order Header - Transfer Order
   1. ORDER_CREATED
   2. ORDER_APPROVED
   3. ORDER_COMPLETED
   4. ORDER_CANCELLED
   
2. Order Item - Transfer Order Item
   1. ITEM_CREATED
   2. **ITEM_PENDING_FULFILL** - newly introduced
   3. **ITEM_PENDING_RECEIPT** - newly introduced*
   4. **ITEM_PENDING_FULFILL_RECEIPT** - newly introduced*
   5. ITEM_COMPLETED
   6. ITEM_CANCELLED

**NOTE** Here the item will not transition to ITEM_APPROVED status since in the Approve TO process, the next possible status could be either
ITEM_PENDING_FULFILL or ITEM_PENDING_RECEIPT based on the statusFlowId.

##### New Status Items 
```
<moqui.basic.StatusItem statusId="ITEM_PENDING_FULFILLMENT" statusTypeId="ORDER_ITEM_STATUS" statusCode="PENDING_FULFILLMENT" description="Pending Fulfillment"/>
<moqui.basic.StatusItem statusId="ITEM_PENDING_RECEIPT" statusTypeId="ORDER_ITEM_STATUS" statusCode="PENDING_RECEIPT" description="Pending Receipt"/>
<moqui.basic.StatusItem statusId="ITEM_PENDING_FULFILL_RECEIPT" statusTypeId="ORDER_ITEM_STATUS" statusCode="PENDING_FULFILL_RECEIPT" description="Pending Fulfillment and Receipt"/>
```

##### New Status Flow and transitions
1. **Transfer Orders to be only Fulfilled in OMS**
```
<!-- Status Flow for Transfer Orders Store to Warehouse -->
<moqui.basic.StatusFlow statusFlowId="TO_Fulfill_Only" statusTypeId="ORDER_ITEM_STATUS" description="Status Flow for Transfer Orders to be fulfilled in OMS and receiving by third party e.g. Store to Warehouse"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_Only" statusId="ITEM_CREATED" toStatusId="ITEM_PENDING_FULFILL" transitionSequence="1" transitionName="Approve Item"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_Only" statusId="ITEM_PENDING_FULFILL" toStatusId="ITEM_COMPLETED" transitionSequence="2" transitionName="Fulfill Item"/>
```

2. **Transfer Orders to be only Received in OMS**
```
<!-- Status Flow for Transfer Orders Warehouse to Store -->
<moqui.basic.StatusFlow statusFlowId="TO_Receive_Only" statusTypeId="ORDER_ITEM_STATUS"  description="Status Flow for Transfer Orders fulfilled by third party and receiving in OMS e.g. Warehouse to Store"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Receive_Only" statusId="ITEM_CREATED" toStatusId="ITEM_PENDING_RECEIPT" transitionSequence="1" transitionName="Approve Item"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Receive_Only" statusId="ITEM_PENDING_RECEIPT" toStatusId="ITEM_COMPLETED" transitionSequence="2" transitionName="Receive Item"/>
```

3. **Transfer Orders to be both Fulfilled & Received in OMS**
```
<!-- Status Flow for Transfer Orders Store to Store -->
<moqui.basic.StatusFlow statusFlowId="TO_Fulfill_And_Receive" statusTypeId="ORDER_ITEM_STATUS"  description="Status Flow for Orders to be both fulfilled and received in OMS e.g. Store to Store"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_And_Receive" statusId="ITEM_CREATED" toStatusId="ITEM_PENDING_FULFILL" transitionSequence="1" transitionName="Approve Item"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_And_Receive" statusId="ITEM_PENDING_FULFILL" toStatusId="ITEM_PENDING_FULFILL_RECEIPT" transitionSequence="2" transitionName="Partial Fulfill Item"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_And_Receive" statusId="ITEM_PENDING_FULFILL" toStatusId="ITEM_PENDING_RECEIPT" transitionSequence="2" transitionName="Fulfill Item"/>
<moqui.basic.StatusFlowTransition statusFlowId="TO_Fulfill_And_Receive" statusId="ITEM_PENDING_RECEIPT" toStatusId="ITEM_COMPLETED" transitionSequence="3" transitionName="Receive Item"/>
```

#### Transfer Order Life cycle

1. **TOs where Fulfillment location is managed by OMS and Receiving location is managed by third party e.g. Store to Warehouse**
   1. statusFlowId="TO_Fulfill_Only"
   2. Flow
      1. TO Created in OMS
         1. TO in ORDER_CREATED and TO Items in ITEM_CREATED status
      2. TO Approval
         1. TO updated from status ORDER_CREATED to ORDER_APPROVED
         2. TO Item updated to statusId="ITEM_PENDING_FULFILLMENT"
         3. Here item reservations should happen in approval since fulfillment in OMS
      3. TO Fulfillment
         1. The [Shipments](createTransferOrderShipment.md) are created for orders
         2. Update the Order Item Status
            - Here a helper service will be used to compare the shippedQty and orderedQty
            - If shippedQty >= orderedQty, OI status is updated to ITEM_COMPLETED, else it remains in ITEM_PENDING_FULFILLMENT
            - This is done on the basis of statusFlowId = TO_Fulfill_Only


2. **TOs where Fulfillment location is managed by third party and Receiving location is managed by OMS e.g. Warehouse to Store**
   1. statusFlowId="TO_Receive_Only"
   2. Flow
      1. TO Created in OMS
         1. TO in ORDER_CREATED and TO Items in ITEM_CREATED status
      2. TO Approval
         1. TO updated from status ORDER_CREATED to ORDER_APPROVED
         2. TO Item updated to statusId="ITEM_PENDING_RECEIPT"
         3. Here No item reservations should happen in approval since only receiving in OMS
      3. TO Receiving
         1. Receive (Partial Receiving) or Receive & Close
            1. The [ShipmentReceipts](receiveTransferOrder.md) are created for order items
            2. Update Order Item Status to ITEM_COMPLETED in case of Receive & Close


3. **TOs where both Fulfillment and Receiving locations are managed by OMS e.g. Store to Store**
   1. statusFlowId="TO_Fulfill_And_Receive"
   2. Flow 
      1. TO Created in OMS
         1. TO in ORDER_CREATED and TO Items in ITEM_CREATED status
      2. TO Approval
         1. TO updated from status ORDER_CREATED to ORDER_APPROVED
         2. TO Item updated to statusId="ITEM_PENDING_FULFILLMENT"
         3. Here item reservations should happen in approval since fulfillment in OMS
      3. TO Fulfillment
         1. The [Shipments](createTransferOrderShipment.md) are created for orders
         2. Update the Order Item Status
           - Here a helper service will be used to compare the shippedQty and orderedQty
           - If shippedQty >= orderedQty, OI status is updated to ITEM_PENDING_RECEIPT, else it should be updated to ITEM_PENDING_FULFILL_RECEIPT
           - This is done on the basis of statusFlowId = TO_Fulfill_And_Receive
      4. TO Receiving
         1. Receive (Partial Receiving) or Receive & Close
            1. The [ShipmentReceipts](receiveTransferOrder.md) are created for order items
            2. Update Order Item Status to ITEM_COMPLETED in case of Receive & Close 


**NOTE**
1. The Fulfillment App will list all TOs where Order is in ORDER_APPROVED status and Items are in ITEM_PENDING_FULFILL status so that they are eligible to be shipped in OMS.
2. The Receiving App will list all TOs where Order is in ORDER_APPROVED status and Items are either in ITEM_PENDING_FULFILL_RECEIPT or ITEM_PENDING_RECEIPT so that they are eligible to be received in OMS.
3. When all the TO items will be COMPLETED, the TO should be marked as COMPLETED, check to use checkCancelCompleteOrder field in change#OrderItemStatus oms service.

#### Receiving unexpected items in a TO

- While receiving a TO, if a new unexpected item is received, the system allows the addition of new item to the TO while receiving.
- The new item will not be added to the order. Shipment, ShipmentItem and ShipmentReceipt will be created. 
- This wil help reconcile the actual and received TO items. 
- The new items received will be identified by fetching the Shipment Receipt Items that do not have order shipment entries.

### Approve Transfer Order

1. Once the TOs are imported in OMS in Created Status, the approval flow for TOs should run.
2. The [approveTransferOrder](../oms/approveTransferOrder.md) service will handle approval of Created TOs in the system.

### Cancel Transfer Order
**TODO** 
1. scenarios of TO cancellation

## Receive Shipment

**Shipment Receiver briefly reviews incoming shipment.**
* If shipment received is a return (has RMA# or Return ID), 
* If shipment received is for a purchase order (has PO#), Shipment Receiver finds the PO corresponding to the items received and records PO receipt (inventory) quantity.
* If shipment received is for a ASN, shipment receiver finds the Shipment.

**Shipment Receiver reviews incoming items. and Shipment Receiver will receive the shipment even if**
* Shipment Receiver records a higher quantity received than was ordered, inventory reconciliation will report it.
* The product is a different color than what is in the system, Shipment Receiver will received it. inventory reconciliation will report it.
* The product that arrives is not the product on the PO or already been received.
